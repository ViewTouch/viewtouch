# Changelog
All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/)


## [Unreleased]
### Added
- **Additional XPM Texture Options**: Added 12 new texture options to enhance UI customization
  - Added 4color.png, brass-8.xpm, concrete-8.xpm, copper-8.xpm, demo-converted.xpm, glass-8.xpm, metal-8.xpm, plastic-8.xpm, silk-8.xpm, steel-8.xpm, stone-8.xpm, velvet-8.xpm
  - Enhanced texture variety for improved visual customization of the interface
- **Scalable Font Support**: Implemented Xft (X FreeType) font rendering system for resolution-independent text display
  - Added XftFont loading with automatic fallback to default fonts when requested fonts are unavailable  
  - Integrated XftTextExtentsUtf8 for accurate scalable font text measurement in UI layout calculations
  - Added XftDrawStringUtf8 rendering with preserved 3D embossed text effects (shadow, highlight, main text)
  - Enhanced error reporting with specific font loading failure messages and fallback notifications
- **Modern C++ Type Safety**: Implemented proper type casting practices throughout font rendering subsystem
  - Added reinterpret_cast for safe conversion between char* and unsigned char* pointer types
  - Added const_cast for legacy X11/Motif library compatibility while maintaining const correctness
- **Modern C++17 Standards Compliance**: Comprehensive modernization of entire codebase infrastructure
  - Implemented modern `using` type alias syntax replacing all legacy `typedef` declarations
  - Added type-safe `nullptr` conversions throughout 200+ files for improved memory safety
  - Integrated modern `#pragma once` header guards replacing legacy `#ifndef` macros in 35+ files
  - Enhanced Str class with C++17 features: move semantics, RAII compliance, and defaulted operations
  - Added explicit buffer size constants preventing future buffer overflow vulnerabilities
- **Comprehensive Debug Infrastructure**: Added detailed diagnostic output for troubleshooting startup and platform-specific issues
  - Added step-by-step debug output for employee database loading with file existence checks and load status reporting
  - Enhanced DownloadFile function with verbose curl output, file size verification, and detailed error categorization
  - Added debug tracking for RestoreBackup operations with return code reporting and error path analysis
  - Implemented platform-specific debug markers for Pi 5 ARM64 vs x86_64 desktop behavior differences
- Interactive `font_check` utility: visually and programmatically verifies all program fonts, displaying each font in an X11 window and logging results to the terminal.

### Changed
- cmake: `gen_compiler_tag`: handle Clang compiler to contain compiler version #163
- **Font System Migration**: Migrated from legacy bitmapped fonts to scalable Xft outline fonts for improved rendering quality and resolution independence
  - Core text rendering in `term/layer.cc` now uses XftTextExtentsUtf8 and XftDrawStringUtf8 for scalable font measurement and rendering
  - Terminal initialization in `term/term_view.cc` loads scalable fonts via XftFontOpenName with fallback support
  - Loader interface in `loader/loader_main.cc` updated to use Xft font rendering for startup messages
  - UI layout calculations in `main/manager.cc` use Xft text measurement for accurate scalable font sizing
- Button Properties Dialog: Updated font choices to provide better progression for scalable fonts, moved away from legacy bitmapped font limitations to more appropriate scalable font sizes
- Dialog fonts: Applied temporary fix changing oversized dialog text from Times 34 to Times 24 Bold in MessageDialog, DialogZone, CreditCardEntryDialog, OpenTabDialog, SimpleDialog, and CreditCardDialog classes
- Global Button Font: Changed default from Times 24 to Times 24 Bold in ZoneDB constructor
- **Cast Modernization**: Updated C-style casts to modern C++ style casts throughout font rendering code
  - Changed `(unsigned const char*)` casts to `reinterpret_cast<const unsigned char*>()` for Xft function compatibility
  - Replaced legacy `(String)` casts with safer `const_cast<char*>()` for X11/Motif string arguments
- **Error Message Enhancement**: Improved font loading diagnostics with detailed fallback notifications and specific error reporting for missing scalable fonts
- **Core Type System Modernization**: Migrated fundamental type definitions from legacy C to modern C++17 standards
  - Converted all `typedef` declarations to modern `using` syntax in `basic.hh` for improved readability
  - Updated type aliases: `using Uchar = unsigned char` (was `typedef unsigned char Uchar`)
  - Enhanced template function definitions with consistent modern syntax
- **Memory Management Modernization**: Comprehensive upgrade of pointer handling throughout codebase
  - Replaced 200+ instances of `NULL` with type-safe `nullptr` across all source files
  - Updated constructor initializations in Product, Vendor, and Credit classes
  - Enhanced method signatures with modern pointer semantics for improved type safety

### Removed
- **Documentation Files**: Removed `SCALABLE_FONTS_MIGRATION.md` per PR review feedback - migration documentation better suited for PR descriptions rather than repository files
- remove GTK+3 dependency, only used in loader, where we revert to use X11 directly #127
- Deleted obsolete font test utilities: `font_test_simple.cc` and `font_demo_example.cc`.
- Cleaned up CMake configuration to only include the new font_check utility for font testing.

### Fixed
- **UI REFRESH AND EDITING ISSUES**: Resolved multiple screen update problems affecting button editing, drag-and-drop, keyboard operations, and open area clicks
  - **Fixed Button Editing Screen Refresh**: Corrected issue where moving, resizing, or unselecting buttons did not immediately update the screen
    - Root cause: Editing functions in `zone/zone.cc` were calling `Draw(0)` instead of `Draw(1)`, preventing immediate refresh
    - Impact: Users had to manually refresh or perform other actions to see button position/size changes
    - Fix: Changed all editing operations to use `Draw(1)` with `update_flag=1` and added `SendNow()` calls for immediate buffer flush
  - **Fixed Report Zone Refresh Blocking**: Resolved issue where `ReportZone::Render()` was forcibly setting `update_flag=0` during temp report processing
    - Root cause: `update_flag` was being overwritten to 0, blocking all screen updates during report rendering
    - Impact: Screen updates were blocked during report operations, affecting overall UI responsiveness
    - Fix: Modified to preserve and restore original `update_flag` while maintaining pagination fixes for long checks
  - **Fixed Keyboard Editing Updates**: Resolved issue where keyboard inputs for resizing buttons (w, W, h, H keys) did not update screen immediately
    - Root cause: Keyboard editing operations in `zone/zone.cc` were not calling `Draw(1)` after position/size changes
    - Impact: Users had to perform additional actions to see keyboard-driven button changes
    - Fix: Added explicit `Draw(1)` calls after all keyboard editing operations including resize, move, and selection commands
  - **Fixed Open Area Click Unselection**: Resolved issue where clicking in open areas did not unselect previously selected buttons
    - Root cause: `Terminal::Touch()` and `Terminal::Mouse()` methods only called `ClearSelectedZone()` when clicking on zones, not in open areas
    - Impact: Users had to click on another button to unselect a selected button, or the selection would persist visually
    - Fix: Added `ClearSelectedZone()` calls when clicking in open areas and enhanced `ClearSelectedZone()` to force immediate screen refresh
  - **Fixed Edit Mode Single-Select Behavior**: Resolved issue where selecting a new button in edit mode would show both the old and new button as selected
    - Root cause: `ZoneDB::ClearEdit()` was using incorrect page iteration and region-based refresh instead of full refresh
    - Impact: Users could not properly single-select buttons in edit mode, making it confusing to work with individual buttons
    - Fix: Updated `ClearEdit()` to properly iterate through current page and parent pages, and force full screen refresh after clearing selections
  - **Enhanced Edit Mode Selection Logic**: Improved single-select vs multi-select behavior in edit mode
    - Root cause: Selection logic was not consistently clearing other selections when clicking on new buttons
    - Impact: Inconsistent selection behavior made edit mode confusing to use
    - Fix: Simplified selection logic to always clear other selections unless Shift is held for multi-select, ensuring predictable single-select behavior
  - **Fixed Multi-Select Drag and Move Operations**: Resolved issues with shift+drag selection and moving multiple selected buttons
    - Root cause: Drag selection logic was not properly handling Shift key, and move operations were clearing other selections
    - Impact: Users could not use shift+drag to select multiple buttons, and moving multiple selected buttons only moved one
    - Fix: Updated drag selection logic to properly handle Shift key, and modified move logic to preserve existing selections when clicking on already-selected zones
  - **Enhanced Drag Selection Screen Refresh**: Improved visual feedback for drag selection operations
    - Root cause: Drag selection was using region-based refresh instead of full screen refresh
    - Impact: Drag selection visual feedback was incomplete or missing
    - Fix: Updated drag selection to use full screen refresh for consistent visual feedback
  - **Fixed Open Area Click Deselection in Edit Mode**: Resolved issue where clicking in open areas did not deselect buttons in edit mode
    - Root cause: Drag selection logic was not clearing existing selections when clicking in open areas
    - Impact: Users had to manually deselect buttons or click on other buttons to clear selections
    - Fix: Added deselection logic to drag selection code, clearing all selections when clicking in open areas (unless Shift is held for multi-select)
  - **Fixed Drag-and-Drop Real-Time Updates**: Resolved issue where left-click dragging buttons did not provide real-time visual feedback
    - Root cause: Mouse drag events in `zone/zone.cc` were making position/size edits without triggering immediate redraw
    - Impact: Users could not see button position/size changes during drag operations until mouse release
    - Fix: Added `Draw(1)` calls after drag move and resize operations to ensure real-time visual feedback during dragging
- **CRITICAL PRICE SAVING BUGS**: Fixed issues preventing correct price changes from being saved
  - **Fixed Price Change Detection**: Resolved issue where changing item prices did not set the `changed` flag in `SalesItem`
    - Root cause: `ItemListZone::SaveRecord()` in `zone/order_zone.cc` was not setting `changed` flag when prices or other fields were modified
    - Impact: Price changes and other field modifications were not being saved to the database
    - Fix: Updated function to set `changed` flag whenever any relevant field (price, name, etc.) is modified
  - **Fixed Price Parsing Format Bug**: Resolved issue where prices were being set to .00 instead of actual values
    - Root cause: `ParsePrice` function in `main/manager.cc` used `%lf` format specifier for `float` type `Flt` and accessed `MasterSystem` without null checks
    - Impact: All price inputs were being parsed as 0.00, breaking price editing functionality
    - Fix: Changed sscanf format from `%lf` to `%f` for float compatibility and added null check for `MasterSystem` with default number format
- **CRITICAL SYSTEM STARTUP FAILURES**: Resolved major platform-specific hang and download issues preventing system startup
  - **Fixed DownloadFile Function**: Corrected critical bug where DownloadFile was writing URL strings to files instead of downloading actual content
    - Root cause: `fout << curlpp::options::Url(url)` was writing URL text instead of performing actual download
    - Impact: All bootstrap files (vt_data, menu.dat, tables.dat, zone_db.dat) were corrupted with URL strings, causing system crashes
    - Fix: Implemented proper curl request with `request.setOpt()` and `request.perform()` for actual file downloads
    - Added timeout and error handling with 30-second download timeout and 10-second connection timeout
  - **Fixed Pi 5 UserDB::Purge() Hang**: Resolved infinite hang in employee database cleanup on Raspberry Pi 5 ARM64 platform
    - Root cause: Memory corruption in Employee linked list causing infinite loop in `DList::Purge()` destructor calls
    - Impact: System would hang indefinitely after "DEBUG: About to call sys->user_db.Purge()" on Pi 5 only
    - Fix: Skip UserDB::Purge() when employee.dat doesn't exist since there's nothing meaningful to purge
    - Platform-specific: Only affects ARM64 Pi systems due to different memory management vs x86_64 desktop systems
  - **Fixed SSL Certificate Issues on Pi 5**: Added HTTP fallback for bootstrap file downloads to resolve SSL certificate problems
    - Root cause: Raspberry Pi 5 systems often have outdated SSL certificates causing HTTPS download failures
    - Impact: Critical system files (zone_db.dat, menu.dat) couldn't be downloaded, resulting in "no zone_db" crashes
    - Fix: Temporarily use HTTP URLs for reliable downloads while preserving HTTPS for security when certificates are available
    - Added comprehensive debug output and error reporting for download troubleshooting
  - **Fixed Missing Directory Creation**: Added automatic creation of required data directories preventing startup failures
    - Added `EnsureDirExists()` calls for archive, current, accounts, expenses, customers, labor, and stock directories
    - Prevents "Can't find directory" errors on fresh installations or incomplete data setups
- **CRITICAL SECURITY VULNERABILITIES**: Eliminated multiple buffer overflow attack vectors that could compromise system security
  - **Buffer Overflow in UnitAmount::Description()**: Fixed `sizeof(str)` bug in `main/inventory.cc` affecting 18+ format operations - replaced with proper `UNIT_DESC_BUFFER_SIZE` constant (256 bytes)
  - **Buffer Overflow in PrintItem()**: Fixed `sizeof(buffer)` bug in `main/sales.cc` affecting menu item formatting - replaced with proper `PRINT_ITEM_BUFFER_SIZE` constant (512 bytes)  
  - **Buffer Overflow in Locale::Page()**: Fixed `sizeof(str)` bug in `main/locale.cc` affecting pagination display - replaced with proper `PAGE_BUFFER_SIZE` constant (32 bytes)
  - **Buffer Overflow in Payment::Description()**: Fixed `sizeof(str)` bug in `main/check.cc` affecting payment processing - replaced with proper `PAYMENT_DESC_BUFFER_SIZE` constant (128 bytes)
- **CRITICAL CREDIT CARD PROCESSING BUGS**: Fixed validation logic failures that could allow invalid transactions
  - **Array Comparison Bug in Credit::operator==()**: Fixed 4 instances in `main/credit.cc` where arrays were compared with `==` instead of `strcmp()` - credit card validation was comparing pointer addresses instead of actual card numbers
  - **Memory Safety in Credit Processing**: Fixed NULL pointer handling throughout credit card processing methods
- **COMPILATION FAILURES**: Resolved build-breaking errors preventing successful compilation
  - **Duplicate Global Variable**: Removed duplicate `last_check_serial` definition in `main/check.cc` causing linker errors
  - **Malformed Nested Loop**: Fixed duplicate for-loop declaration in PrintWorkOrder method causing parser confusion and cascading syntax errors
  - **Function Trace Bug**: Corrected `Payment::IsEqual()` FnTrace call that was incorrectly calling `Payment::IsTab()`
- **Font System Build Errors**: Resolved compilation failures preventing scalable font system from building
  - Fixed `invalid 'static_cast' from type 'const char*' to type 'const unsigned char*'` errors in text rendering functions
  - Corrected type casting issues in `term/layer.cc`, `loader/loader_main.cc`, and `main/manager.cc` for Xft font compatibility
  - Fixed parameter type syntax error in `main/license_hash.cc` (`unsigned const char*` â†’ `const unsigned char*`)
- **Compiler Warnings**: Eliminated 50+ warnings that were cluttering build output
  - Fixed ISO C++ string constant warnings: "forbids converting a string constant to 'String'" in X11/Motif code
  - Resolved format truncation warnings by increasing buffer sizes in `term/term_view.cc` and other files
  - Applied `const_cast<char*>()` fixes for X11/Motif compatibility in widget creation and dialog titles
- **Build System**: Ensured complete compilation of all executables (vt_main, vt_term, vt_print, vt_cdu) and test suite
- **Code Documentation**: Added comprehensive inline comments explaining all font system changes, cast fixes, and compatibility requirements for future maintenance
- **CRITICAL DIRECTORY ACCESS ISSUE**: Fixed directory permission bug introduced during C++17 refactor that made `/usr/viewtouch/dat` inaccessible
  - **Root Cause**: C++17 refactor added `umask(0111)` in `main/manager.cc` which removed execute permissions from all created directories
  - **Impact**: Directories created with `mkdir(dirname, 0755)` resulted in 644 permissions instead of 755, breaking file manager access with "Access was denied" errors
  - **Fix**: Changed `umask(0111)` to `umask(0022)` to preserve execute permissions needed for directory access while maintaining security
  - **Directory Permissions**: Updated `scripts/vtcommands.pl` to use 0775 permissions for bin/dat directories to ensure consistency
  - **Result**: Directories now receive proper 755 permissions (rwxr-xr-x) allowing normal file manager access
- **CRITICAL TEST FAILURE**: Fixed `test_data_file` failure caused by incorrect format specifier in float serialization
  - **Float Format Bug in InputDataFile::Read()**: Fixed `sscanf(str, "%lf", &v)` bug in `data_file.cc` - wrong format specifier for `Flt` type
  - Root cause: `Flt` is typedef'd as `float` but Read method used `%lf` (double format) instead of `%f` (float format)
  - Impact: Float values were reading as `0.0f` instead of actual values, breaking data file serialization
  - Result: Complete test suite now passes at 100% success rate
- fix configure step by searching for `PkgConfig` before using `pkg_check_module` #128
- update embedded `catch.hpp` to `v2.13.10` to fix compilation on Ubuntu 20.04 and newer #131
- fix `TimeInfo.Set(date_string)` function fixing `RunReport` `to`/`from` fields and C++20 compatibility #145
- update embedded `date` to `v3.0.4` and fix CMake 4+ compatibility #155
- **Edit Mode UI Consistency and Functionality**: Fixed minor UI issues in edit mode for improved user experience
  - **Fixed Edit Toolbar Font Size Consistency**: Resolved inconsistent font sizes in edit toolbar where top/bottom buttons used larger fonts than middle buttons
    - Root cause: New Button, New Page, Prior Page, and Next Page used `FONT_TIMES_18` while middle 8 buttons used `FONT_TIMES_14`
    - Impact: Visual inconsistency made toolbar appear unbalanced and unprofessional
    - Fix: Updated all middle buttons (Select All, Toggle Selected, Copy Selected, Move Selected, Delete Button, Global Page Defaults, Show Button Info, Show Page List) to use `FONT_TIMES_18` for consistent appearance
  - **Fixed Right-Click Page Properties Dialog**: Resolved issue where right-clicking on page bar did not open page properties dialog
    - Root cause: Right-click handling was only inside `MOUSE_PRESS` block, preventing detection of right-click events that might be sent as different event types
    - Impact: Users could not access page properties dialog via right-click on page bar, limiting edit mode functionality
    - Fix: Moved right-click handling outside of `MOUSE_PRESS` block to ensure right-click events are processed regardless of event type (press/release)
    - Result: Right-click on page bar (top 32 pixels) now properly opens page properties dialog for editing page settings
- update embedded `