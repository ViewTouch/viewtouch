#!/bin/bash
#
# ViewTouch SSH Security Management Script
#

SCRIPT_NAME=$(basename "$0")

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging functions
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Check if running as root
check_root() {
    if [ "$EUID" -ne 0 ]; then
        log_error "This script must be run as root"
        exit 1
    fi
}

# Validate SSH key
validate_key() {
    local key_path="$1"

    if [ ! -f "$key_path" ]; then
        log_error "SSH key not found: $key_path"
        return 1
    fi

    # Check file permissions
    local perms=$(stat -c '%a' "$key_path")
    if [ "$perms" != "600" ]; then
        log_warning "SSH private key has incorrect permissions: $perms (should be 600)"
        return 1
    fi

    # Check if it's a valid SSH key
    if ! ssh-keygen -l -f "$key_path" >/dev/null 2>&1; then
        log_error "Invalid SSH key format: $key_path"
        return 1
    fi

    log_success "SSH key validation passed: $key_path"
    return 0
}

# Rotate SSH key
rotate_key() {
    local key_path="$1"
    local backup_dir="/usr/viewtouch/ssh/backups"

    if [ ! -f "$key_path" ]; then
        log_error "SSH key not found: $key_path"
        return 1
    fi

    # Create backup directory
    mkdir -p "$backup_dir"

    # Create backup with timestamp
    local timestamp=$(date +%Y%m%d_%H%M%S)
    local backup_key="$backup_dir/$(basename "$key_path").$timestamp"
    local backup_pub="$backup_dir/$(basename "$key_path").$timestamp.pub"

    cp "$key_path" "$backup_key"
    cp "${key_path}.pub" "$backup_pub"

    log_info "Backed up existing key to: $backup_key"

    # Generate new key
    local key_comment="viewtouch-reverse-ssh-$(hostname)-$timestamp"
    ssh-keygen -t ed25519 -f "$key_path" -N '' -C "$key_comment" 2>/dev/null

    if [ $? -eq 0 ]; then
        chmod 600 "$key_path"
        chmod 644 "${key_path}.pub"
        log_success "SSH key rotated successfully"
        log_info "New public key (${key_path}.pub):"
        cat "${key_path}.pub"
        log_info ""
        log_warning "IMPORTANT: Update the authorized_keys file on your management server with the new public key"
        return 0
    else
        log_error "Failed to rotate SSH key"
        return 1
    fi
}

# Check SSH server security
check_ssh_security() {
    local sshd_config="/etc/ssh/sshd_config"

    log_info "Checking SSH server security configuration..."

    # Check if file exists
    if [ ! -f "$sshd_config" ]; then
        log_error "SSH server config not found: $sshd_config"
        return 1
    fi

    local issues_found=0

    # Check password authentication
    if grep -q "^PasswordAuthentication yes" "$sshd_config" 2>/dev/null; then
        log_warning "Password authentication is enabled - consider disabling for key-only authentication"
        issues_found=$((issues_found + 1))
    fi

    # Check root login
    if grep -q "^PermitRootLogin yes" "$sshd_config" 2>/dev/null; then
        log_warning "Root login is permitted - consider restricting to specific users"
        issues_found=$((issues_found + 1))
    fi

    # Check port (avoid default port 22)
    local ssh_port=$(grep "^Port " "$sshd_config" 2>/dev/null | awk '{print $2}')
    if [ "$ssh_port" = "22" ] || [ -z "$ssh_port" ]; then
        log_warning "SSH server is using default port 22 - consider changing to a non-standard port"
        issues_found=$((issues_found + 1))
    fi

    # Check MaxAuthTries
    local max_auth=$(grep "^MaxAuthTries " "$sshd_config" 2>/dev/null | awk '{print $2}')
    if [ -z "$max_auth" ] || [ "$max_auth" -gt 3 ]; then
        log_warning "MaxAuthTries is not set or too high - consider setting to 3 or lower"
        issues_found=$((issues_found + 1))
    fi

    # Check PermitEmptyPasswords
    if grep -q "^PermitEmptyPasswords yes" "$sshd_config" 2>/dev/null; then
        log_error "Empty passwords are permitted - this is a security risk"
        issues_found=$((issues_found + 1))
    fi

    if [ $issues_found -eq 0 ]; then
        log_success "SSH server security check passed"
    else
        log_warning "Found $issues_found security issues in SSH configuration"
    fi

    return $issues_found
}

# Harden SSH configuration
harden_ssh_config() {
    local sshd_config="/etc/ssh/sshd_config"
    local backup_config="$sshd_config.backup.$(date +%Y%m%d_%H%M%S)"

    log_info "Hardening SSH server configuration..."

    # Create backup
    cp "$sshd_config" "$backup_config"
    log_info "Backup created: $backup_config"

    # Apply security settings
    cat >> "$sshd_config" << 'EOF'

# ViewTouch SSH Security Hardening
# Added by vt_ssh_security script

# Disable password authentication
PasswordAuthentication no

# Disable root login
PermitRootLogin no

# Limit authentication attempts
MaxAuthTries 3

# Disable empty passwords
PermitEmptyPasswords no

# Enable public key authentication
PubkeyAuthentication yes

# Enable tunneling
PermitTunnel yes
GatewayPorts yes

# Disable X11 forwarding for security
X11Forwarding no

# Set login grace time
LoginGraceTime 30

# Enable reverse DNS lookup (helps with logging)
UseDNS yes

# Log more information
LogLevel VERBOSE

EOF

    log_success "SSH configuration hardened"
    log_warning "Please review the changes in $sshd_config and restart SSH service:"
    log_warning "  sudo systemctl restart ssh"
}

# Generate SSH configuration for management server
generate_mgmt_config() {
    local mgmt_config="/etc/ssh/ssh_config.d/viewtouch_management"

    log_info "Generating SSH client configuration for management server..."

    cat > "$mgmt_config" << 'EOF'
# ViewTouch Management Server SSH Configuration
# Generated by vt_ssh_security script

Host management.viewtouch.com
    # Security settings
    PasswordAuthentication no
    PubkeyAuthentication yes
    IdentitiesOnly yes

    # Connection settings
    ConnectTimeout 30
    ServerAliveInterval 60
    ServerAliveCountMax 3

    # Disable potentially dangerous features
    ForwardX11 no
    ForwardAgent no

    # Strict host key checking for management servers
    StrictHostKeyChecking yes
    UserKnownHostsFile ~/.ssh/known_hosts

    # Compression for better performance
    Compression yes

EOF

    chmod 644 "$mgmt_config"
    log_success "Management server SSH config created: $mgmt_config"
}

# Check file permissions for SSH directory
check_permissions() {
    local ssh_dir="/usr/viewtouch/ssh"
    local issues_found=0

    log_info "Checking SSH file permissions..."

    # Check SSH directory
    if [ -d "$ssh_dir" ]; then
        local dir_perms=$(stat -c '%a' "$ssh_dir")
        if [ "$dir_perms" != "700" ]; then
            log_warning "SSH directory has incorrect permissions: $dir_perms (should be 700)"
            issues_found=$((issues_found + 1))
        fi

        local dir_owner=$(stat -c '%U:%G' "$ssh_dir")
        if [ "$dir_owner" != "root:root" ]; then
            log_warning "SSH directory has incorrect ownership: $dir_owner (should be root:root)"
            issues_found=$((issues_found + 1))
        fi
    else
        log_warning "SSH directory does not exist: $ssh_dir"
    fi

    # Check SSH keys
    for key_file in "$ssh_dir"/*; do
        if [ -f "$key_file" ] && [[ "$key_file" == *.key || "$key_file" == *id_* ]]; then
            if [[ "$key_file" != *.pub ]]; then
                # Private key
                local key_perms=$(stat -c '%a' "$key_file")
                if [ "$key_perms" != "600" ]; then
                    log_warning "SSH private key has incorrect permissions: $key_file ($key_perms should be 600)"
                    issues_found=$((issues_found + 1))
                fi
            else
                # Public key
                local key_perms=$(stat -c '%a' "$key_file")
                if [ "$key_perms" != "644" ]; then
                    log_warning "SSH public key has incorrect permissions: $key_file ($key_perms should be 644)"
                    issues_found=$((issues_found + 1))
                fi
            fi
        fi
    done

    if [ $issues_found -eq 0 ]; then
        log_success "SSH file permissions check passed"
    else
        log_warning "Found $issues_found permission issues"
    fi

    return $issues_found
}

# Fix file permissions
fix_permissions() {
    local ssh_dir="/usr/viewtouch/ssh"

    log_info "Fixing SSH file permissions..."

    # Create SSH directory if it doesn't exist
    if [ ! -d "$ssh_dir" ]; then
        mkdir -p "$ssh_dir"
        log_info "Created SSH directory: $ssh_dir"
    fi

    # Set directory permissions
    chmod 700 "$ssh_dir"
    chown root:root "$ssh_dir"
    log_info "Fixed SSH directory permissions"

    # Fix key permissions
    for key_file in "$ssh_dir"/*; do
        if [ -f "$key_file" ]; then
            if [[ "$key_file" != *.pub ]]; then
                # Private key
                chmod 600 "$key_file"
                chown root:root "$key_file"
            else
                # Public key
                chmod 644 "$key_file"
                chown root:root "$key_file"
            fi
        fi
    done

    log_success "SSH file permissions fixed"
}

# Show usage
show_usage() {
    echo "ViewTouch SSH Security Management Script"
    echo ""
    echo "Usage: $SCRIPT_NAME [COMMAND] [OPTIONS]"
    echo ""
    echo "Commands:"
    echo "  validate-key [key_path]    Validate SSH key file"
    echo "  rotate-key [key_path]      Rotate SSH key pair with backup"
    echo "  check-ssh                  Check SSH server security configuration"
    echo "  harden-ssh                 Harden SSH server configuration"
    echo "  gen-mgmt-config            Generate SSH client config for management servers"
    echo "  check-perms                Check SSH file permissions"
    echo "  fix-perms                  Fix SSH file permissions"
    echo "  audit                      Run full security audit"
    echo "  help                       Show this help message"
    echo ""
    echo "Examples:"
    echo "  $SCRIPT_NAME validate-key /usr/viewtouch/ssh/reverse_ssh_key"
    echo "  $SCRIPT_NAME rotate-key /usr/viewtouch/ssh/reverse_ssh_key"
    echo "  $SCRIPT_NAME audit"
}

# Run full security audit
run_audit() {
    log_info "Running full SSH security audit..."
    echo "========================================"

    local total_issues=0

    echo ""
    log_info "Checking SSH file permissions..."
    if ! check_permissions; then
        total_issues=$((total_issues + 1))
    fi

    echo ""
    log_info "Checking SSH server security..."
    if ! check_ssh_security; then
        total_issues=$((total_issues + 1))
    fi

    echo ""
    log_info "Checking SSH keys..."
    local key_path="/usr/viewtouch/ssh/reverse_ssh_key"
    if [ -f "$key_path" ]; then
        if ! validate_key "$key_path"; then
            total_issues=$((total_issues + 1))
        fi
    else
        log_warning "SSH key not found: $key_path"
        total_issues=$((total_issues + 1))
    fi

    echo ""
    echo "========================================"
    if [ $total_issues -eq 0 ]; then
        log_success "SSH security audit passed - no issues found"
    else
        log_warning "SSH security audit found $total_issues issue(s)"
        echo ""
        log_info "Recommendations:"
        echo "  - Run '$SCRIPT_NAME fix-perms' to fix permission issues"
        echo "  - Run '$SCRIPT_NAME harden-ssh' to harden SSH configuration"
        echo "  - Run '$SCRIPT_NAME rotate-key' to rotate SSH keys if compromised"
    fi

    return $total_issues
}

# Main function
main() {
    case "${1:-help}" in
        validate-key)
            check_root
            local key_path="${2:-/usr/viewtouch/ssh/reverse_ssh_key}"
            validate_key "$key_path"
            ;;
        rotate-key)
            check_root
            local key_path="${2:-/usr/viewtouch/ssh/reverse_ssh_key}"
            rotate_key "$key_path"
            ;;
        check-ssh)
            check_root
            check_ssh_security
            ;;
        harden-ssh)
            check_root
            harden_ssh_config
            ;;
        gen-mgmt-config)
            check_root
            generate_mgmt_config
            ;;
        check-perms)
            check_root
            check_permissions
            ;;
        fix-perms)
            check_root
            fix_permissions
            ;;
        audit)
            check_root
            run_audit
            ;;
        help|--help|-h)
            show_usage
            ;;
        *)
            log_error "Unknown command: $1"
            echo ""
            show_usage
            exit 1
            ;;
    esac
}

main "$@"
